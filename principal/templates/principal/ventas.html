{% load l10n %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Punto de Venta - Comercial 2 Hermanos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #e9ecef; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .navbar { flex-shrink: 0; z-index: 1000; }
        .main-container { flex-grow: 1; overflow: hidden; padding: 15px; height: 100%; }
        .col-productos { display: flex; flex-direction: column; height: 100%; }
        .grid-scroll { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 50px; }
        .col-ticket { height: 100%; display: flex; flex-direction: column; }
        .ticket-card { height: 100%; display: flex; flex-direction: column; border: none; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); }
        .ticket-header { flex-shrink: 0; padding: 15px; background: #212529; color: white; }
        .ticket-body-scroll { flex-grow: 1; overflow-y: auto; padding: 0; background: white; border-bottom: 1px solid #dee2e6; } 
        .ticket-footer { flex-shrink: 0; padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; }
        .product-card { cursor: pointer; transition: transform 0.1s; border: 1px solid #dee2e6; background: white; user-select: none; position: relative; }
        .product-card:active { transform: scale(0.95); }
        .product-card:hover { border-color: #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .stock-badge { position: absolute; top: 5px; right: 5px; font-size: 0.75rem; z-index: 10; }
        .money-input { font-size: 1.2rem; font-weight: bold; color: #198754; text-align: right; }
        .change-display { font-size: 1.2rem; font-weight: bold; color: #dc3545; text-align: right; }
        /* Estilo para el cliente seleccionado */
        .cliente-seleccionado { background-color: #0d6efd; color: white; padding: 8px; border-radius: 5px; margin-top: 5px; font-size: 0.95rem; display: flex; align-items: center; justify-content: space-between; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary px-3 shadow-sm">
        <span class="navbar-brand mb-0 h1 fw-bold"><i class="bi bi-basket2-fill"></i> Comercial 2 Hermanos</span>
        <div class="d-flex align-items-center gap-3">
            <span class="text-white small"><i class="bi bi-person-circle"></i> {{ user.username|upper }}</span>
            <a href="{% url 'menu' %}" class="btn btn-sm btn-light fw-bold text-primary border shadow-sm">
                <i class="bi bi-house-door-fill"></i> Volver al Men√∫
            </a>
        </div>
    </nav>

    <div class="container-fluid main-container">
        <div class="row h-100">
            
            <div class="col-md-8 col-productos">
                <div class="input-group mb-3 shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-qr-code-scan text-primary"></i></span>
                    <input type="text" id="buscador" class="form-control form-control-lg border-start-0" placeholder="Escanear producto..." autocomplete="off">
                </div>

                <div class="grid-scroll">
                    {% if not productos %}
                        <div class="alert alert-warning text-center mt-5">
                            <h4><i class="bi bi-exclamation-triangle"></i> No hay productos registrados</h4>
                            <p>Vaya al m√≥dulo de "Ingreso Mercader√≠a" para crear productos.</p>
                        </div>
                    {% endif %}

                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2" id="grid-productos">
                        {% for p in productos %}
                        <div class="col producto-item" data-nombre="{{ p.nombre|lower }}" data-codigo="{{ p.codigo }}">
                            <div class="card product-card h-100 p-2"
                                 onclick="agregarAlCarrito({{ p.id }}, '{{ p.nombre|escapejs }}', {{ p.precio_venta|unlocalize }}, '{{ p.stock_actual|unlocalize }}', {{ p.es_granel|yesno:'true,false' }}, {{ p.precio_costo|unlocalize }})">
                                
                                {% if p.stock_actual > 0 %}
                                    <span class="badge bg-success stock-badge">
                                        {{ p.stock_actual|floatformat:2 }} {% if p.es_granel %}Lb{% endif %}
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger stock-badge">AGOTADO</span>
                                {% endif %}

                                <div class="text-center mt-3 p-2">
                                    <h6 class="text-dark fw-bold mb-1 text-uppercase small">{{ p.nombre }}</h6>
                                    <h4 class="text-primary fw-bold mb-0">${{ p.precio_venta }}</h4>
                                    {% if p.es_granel %}
                                        <span class="badge bg-warning text-dark mt-1" style="font-size: 0.6rem;">POR PESO / GRANEL</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-4 col-ticket">
                <div class="card ticket-card">
                    <div class="ticket-header">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="bi bi-cart4"></i> Venta Actual</h5>
                            <span class="badge bg-warning text-dark" id="cart-count">0 items</span>
                        </div>
                        
                        <div class="mb-2">
                            <label class="small text-muted mb-1">Buscar Cliente (Enter para buscar)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-secondary text-white"><i class="bi bi-person-search"></i></span>
                                <input type="text" id="buscador-cliente" class="form-control fw-bold" placeholder="RUC o Nombre..." autocomplete="off">
                                <button class="btn btn-light" type="button" onclick="buscarClienteManual()"><i class="bi bi-search"></i></button>
                            </div>
                        </div>

                        <div class="col-12 mb-2">
                            <select id="select-cliente" class="form-select form-select-sm fw-bold" style="display:none;">
                                <option value="" data-mayorista="false">Seleccionar Cliente</option>
                                {% for c in clientes %}
                                    <option value="{{ c.id }}" data-mayorista="{{ c.es_mayorista|yesno:'true,false' }}" data-texto="{{ c.ruc_cedula }} {{ c.nombre|lower }}" {% if c.nombre|upper == 'CONSUMIDOR FINAL' %}selected{% endif %}>
                                        {{ c.nombre }} ({{ c.ruc_cedula|default:'S/N' }})
                                    </option>
                                {% empty %}
                                    <option value="">No hay clientes</option>
                                {% endfor %}
                            </select>
                            
                            <div id="cliente-display" class="cliente-seleccionado shadow-sm">
                                <div><i class="bi bi-person-check-fill"></i> <span id="nombre-cliente-display" class="fw-bold">CONSUMIDOR FINAL</span></div>
                                <span id="badge-mayorista" class="badge bg-warning text-dark" style="display:none;">MAYORISTA</span>
                            </div>
                        </div>

                        <div class="col-12">
                            <select id="select-pago" class="form-select form-select-sm fw-bold" onchange="verificarCredito()">
                                <option value="EFECTIVO">üíµ Efectivo</option>
                                <option value="TARJETA">üí≥ Tarjeta</option>
                                <option value="TRANSFERENCIA">üè¶ Transferencia</option>
                                <option value="CREDITO" class="text-danger">üìï Cr√©dito / Fiado</option>
                            </select>
                        </div>
                    </div>

                    <div class="ticket-body-scroll">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-dark sticky-top small">
                                <tr>
                                    <th class="ps-3">Desc.</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-center">Precio</th>
                                    <th class="text-end pe-3">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabla-carrito"></tbody>
                        </table>
                        <div id="empty-msg" class="text-center text-muted mt-5">
                            <i class="bi bi-cart-x display-1 opacity-25"></i><p>Carrito vac√≠o</p>
                        </div>
                    </div>

                    <div class="ticket-footer">
                        <div class="row mb-3 bg-light border rounded p-2 mx-0 align-items-center" id="bloque-dinero">
                            <div class="col-6 p-1">
                                <label class="small text-muted fw-bold">RECIBIDO ($)</label>
                                <input type="number" id="monto-recibido" class="form-control money-input" placeholder="0.00" onkeyup="calcularCambio()">
                            </div>
                            <div class="col-6 p-1 text-end">
                                <label class="small text-muted fw-bold">CAMBIO ($)</label>
                                <div id="monto-cambio" class="change-display">0.00</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="h4 mb-0 text-secondary">TOTAL:</span>
                            <span class="h2 mb-0 fw-bold text-success">$<span id="total-venta">0.00</span></span>
                        </div>
                        <div class="d-grid gap-2">
                            <button onclick="procesarVenta()" class="btn btn-success btn-lg fw-bold shadow-sm" id="btn-confirmar">
                                <i class="bi bi-check-circle-fill"></i> CONFIRMAR (F2)
                            </button>
                            <button onclick="confirmarCancelar()" class="btn btn-outline-danger">
                                <i class="bi bi-trash3"></i> Cancelar Venta
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGranel" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-bold"><i class="bi bi-calculator"></i> Venta por Peso/Valor</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <h4 id="granel-nombre" class="text-center text-primary mb-3">Producto</h4>
            <h5 class="text-center text-muted">Precio por Libra: $<span id="granel-precio">0.00</span></h5>
            <hr>
            <div class="row g-3">
                <div class="col-6">
                    <label class="fw-bold text-success">Quiero vender ($):</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" id="input-dinero" class="form-control form-control-lg fw-bold text-success" placeholder="1.00" step="0.05">
                    </div>
                </div>
                <div class="col-6">
                    <label class="fw-bold text-primary">Peso (Lb):</label>
                    <div class="input-group">
                        <input type="number" id="input-peso" class="form-control form-control-lg fw-bold text-primary" placeholder="0.000" step="0.001">
                        <span class="input-group-text">Lb</span>
                    </div>
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success fw-bold" onclick="confirmarGranel()">Agregar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalNuevoCliente" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-primary">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person-plus-fill"></i> Registrar Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevoCliente">
                        <div class="mb-3">
                            <label class="form-label fw-bold">RUC / C√©dula *</label>
                            <input type="text" id="new-ruc" class="form-control" required placeholder="Ej: 0999999999">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre Completo *</label>
                            <input type="text" id="new-nombre" class="form-control" required placeholder="Ej: Juan P√©rez">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Tel√©fono</label>
                                <input type="text" id="new-telefono" class="form-control">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">¬øEs Mayorista?</label>
                                <div class="form-check form-switch pt-2">
                                    <input class="form-check-input" type="checkbox" id="new-mayorista" style="width:40px; height:20px;">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Direcci√≥n</label>
                            <textarea id="new-direccion" class="form-control" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary fw-bold" onclick="guardarClienteRapido()">
                        <i class="bi bi-save"></i> Guardar y Usar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let carrito = {}; 
        let productoActualGranel = null; 
        let clienteEsMayorista = false; 

        const modalGranel = new bootstrap.Modal(document.getElementById('modalGranel'));
        const modalNuevoCliente = new bootstrap.Modal(document.getElementById('modalNuevoCliente'));

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('buscador').focus();
            actualizarVisualizadorCliente(); // Cargar consumidor final al inicio
        });

        // ============================================
        // NUEVA L√ìGICA DE B√öSQUEDA DE CLIENTES
        // ============================================
        
        document.getElementById('buscador-cliente').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') buscarClienteManual();
        });

        function buscarClienteManual() {
            let texto = document.getElementById('buscador-cliente').value.toLowerCase().trim();
            if(!texto) return;

            let select = document.getElementById('select-cliente');
            let opciones = Array.from(select.options);
            
            // Buscar coincidencia en el texto (RUC o Nombre)
            let encontrado = opciones.find(opt => {
                let data = opt.getAttribute('data-texto') || "";
                return data.includes(texto);
            });

            if(encontrado) {
                // Si existe, lo seleccionamos
                select.value = encontrado.value;
                actualizarVisualizadorCliente(); // Actualiza el cuadrito azul y la variable mayorista
                document.getElementById('buscador-cliente').value = ''; // Limpiar
                Swal.fire({toast:true, icon:'success', title:'Cliente encontrado', position:'top-end', timer:1500, showConfirmButton:false});
            } else {
                // Si NO existe, preguntar si crear
                Swal.fire({
                    title: 'Cliente no encontrado',
                    text: `No existe "${texto}". ¬øDesea registrarlo ahora?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, Registrar',
                    cancelButtonText: 'No'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Abrir modal y pre-llenar datos si parece c√©dula o nombre
                        document.getElementById('formNuevoCliente').reset();
                        if(!isNaN(texto) && texto.length >= 10) {
                            document.getElementById('new-ruc').value = texto;
                        } else {
                            document.getElementById('new-nombre').value = texto.toUpperCase();
                        }
                        modalNuevoCliente.show();
                        setTimeout(() => document.getElementById('new-ruc').focus(), 500);
                    }
                });
            }
        }

        function guardarClienteRapido() {
            let ruc = document.getElementById('new-ruc').value;
            let nombre = document.getElementById('new-nombre').value;
            let telefono = document.getElementById('new-telefono').value;
            let direccion = document.getElementById('new-direccion').value;
            let mayorista = document.getElementById('new-mayorista').checked;

            if(!ruc || !nombre) return Swal.fire('Error', 'RUC y Nombre son obligatorios', 'error');

            fetch("{% url 'crear_cliente_rapido' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ ruc, nombre, telefono, direccion, es_mayorista: mayorista })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    // Crear la opci√≥n en el select din√°micamente
                    let select = document.getElementById('select-cliente');
                    let option = document.createElement("option");
                    option.value = data.cliente.id;
                    option.text = `${data.cliente.nombre} (${data.cliente.ruc})`;
                    option.setAttribute('data-mayorista', data.cliente.es_mayorista ? 'true' : 'false');
                    option.setAttribute('data-texto', `${data.cliente.ruc} ${data.cliente.nombre.toLowerCase()}`);
                    
                    select.add(option);
                    select.value = data.cliente.id; // Seleccionar el nuevo
                    
                    actualizarVisualizadorCliente();
                    modalNuevoCliente.hide();
                    Swal.fire('Guardado', 'Cliente registrado y seleccionado', 'success');
                } else {
                    Swal.fire('Error', data.mensaje, 'error');
                }
            });
        }

        function actualizarVisualizadorCliente() {
            let select = document.getElementById('select-cliente');
            let opcion = select.options[select.selectedIndex];
            
            // Mostrar nombre visualmente
            document.getElementById('nombre-cliente-display').innerText = opcion.text;
            
            // L√≥gica Mayorista
            let esVip = (opcion.getAttribute('data-mayorista') === 'true');
            let badge = document.getElementById('badge-mayorista');
            
            if (esVip) {
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }

            if (esVip !== clienteEsMayorista) {
                clienteEsMayorista = esVip;
                if(clienteEsMayorista) Swal.fire({toast:true, icon:'info', title:'Precios Mayorista Activados', position:'top-end', timer:2000, showConfirmButton:false});
                renderizarTabla();
            }
        }

        // ============================================
        // L√ìGICA DE PRODUCTOS (IGUAL QUE ANTES)
        // ============================================

        document.getElementById('buscador').addEventListener('keyup', function(e) {
            let texto = e.target.value.toLowerCase();
            let items = document.querySelectorAll('.producto-item');
            
            if(e.key === 'Enter') {
                let exacto = Array.from(items).find(item => item.dataset.codigo === texto);
                if(exacto) {
                    exacto.querySelector('.card').click();
                    this.value = '';
                    return;
                }
            }

            items.forEach(item => {
                let nombre = item.dataset.nombre;
                let codigo = item.dataset.codigo;
                item.style.display = (nombre.includes(texto) || codigo.includes(texto)) ? 'block' : 'none';
            });
        });

        function agregarAlCarrito(id, nombre, precio, stockMax, esGranel, costo) {
            stockMax = parseFloat(stockMax);
            costo = parseFloat(costo);
            
            if (esGranel === false) {
                if (stockMax <= 0) return Swal.fire({toast:true, icon:'error', title:'¬°Agotado!', showConfirmButton:false, timer:1000});
                
                if (carrito[id]) {
                    if (carrito[id].cantidad + 1 > stockMax) return Swal.fire({toast:true, icon:'warning', title:'Stock M√°ximo', timer:1000});
                    carrito[id].cantidad++;
                    carrito[id].subtotal = carrito[id].cantidad * carrito[id].precio;
                } else {
                    carrito[id] = { nombre, precio: parseFloat(precio), costo, cantidad: 1, subtotal: parseFloat(precio), stockMax, esGranel: false };
                }
                renderizarTabla();
            } else {
                productoActualGranel = { id, nombre, precio, stockMax, costo };
                document.getElementById('granel-nombre').innerText = nombre;
                document.getElementById('granel-precio').innerText = precio.toFixed(2);
                document.getElementById('input-dinero').value = ''; 
                document.getElementById('input-peso').value = '';   
                modalGranel.show();
                setTimeout(() => document.getElementById('input-dinero').focus(), 500);
            }
        }

        // ... [Calculadora Granel] ...
        document.getElementById('input-dinero').addEventListener('input', function(e) {
            let dinero = parseFloat(e.target.value);
            if (!isNaN(dinero) && productoActualGranel.precio > 0) {
                document.getElementById('input-peso').value = (dinero / productoActualGranel.precio).toFixed(3);
            }
        });
        document.getElementById('input-peso').addEventListener('input', function(e) {
            let peso = parseFloat(e.target.value);
            if (!isNaN(peso)) {
                document.getElementById('input-dinero').value = (peso * productoActualGranel.precio).toFixed(2);
            }
        });

        function confirmarGranel() {
            let peso = parseFloat(document.getElementById('input-peso').value);
            let dinero = parseFloat(document.getElementById('input-dinero').value);
            if (!peso || peso <= 0) return Swal.fire('Valor inv√°lido', '', 'warning');
            
            let id = productoActualGranel.id;
            if (carrito[id] && (carrito[id].cantidad + peso) > productoActualGranel.stockMax) return Swal.fire('Stock insuficiente', '', 'warning');
            
            if (carrito[id]) {
                carrito[id].cantidad += peso;
                carrito[id].subtotal = carrito[id].cantidad * carrito[id].precio;
            } else {
                carrito[id] = { nombre: productoActualGranel.nombre, precio: productoActualGranel.precio, costo: productoActualGranel.costo, cantidad: peso, subtotal: dinero, stockMax: productoActualGranel.stockMax, esGranel: true };
            }
            modalGranel.hide();
            renderizarTabla();
        }

        function renderizarTabla() {
            let tbody = document.getElementById('tabla-carrito');
            tbody.innerHTML = '';
            let total = 0;
            let count = 0;
            let hasItems = false;

            for (let id in carrito) {
                hasItems = true;
                let item = carrito[id];
                total += item.subtotal;
                count++; 

                let cantidadDisplay = item.esGranel ? item.cantidad.toFixed(2) + " Lb" : item.cantidad.toFixed(0) + " Ud";
                
                let precioDisplay;
                if (clienteEsMayorista) {
                    precioDisplay = `<input type="number" class="form-control form-control-sm text-center p-0 mx-auto text-primary fw-bold" 
                                      value="${item.precio.toFixed(2)}" step="0.01"
                                      onchange="cambiarPrecio(${id}, this.value)" style="width: 70px;">`;
                } else {
                    precioDisplay = `$${item.precio.toFixed(2)}`;
                }

                tbody.innerHTML += `<tr>
                    <td class="ps-3 align-middle"><small class="fw-bold">${item.nombre}</small></td>
                    <td class="text-center align-middle">
                         ${item.esGranel ? `<span class="fw-bold text-primary">${cantidadDisplay}</span>` 
                         : `<input type="number" class="form-control form-control-sm text-center mx-auto" value="${item.cantidad}" onchange="cambiarCantidad(${id}, this.value)" style="width: 50px;">`}
                    </td>
                    <td class="text-center align-middle">${precioDisplay}</td>
                    <td class="text-end pe-3 fw-bold align-middle">$${item.subtotal.toFixed(2)}</td>
                    <td class="text-center align-middle"><i class="bi bi-x-circle text-danger" style="cursor: pointer;" onclick="eliminarItem(${id})"></i></td>
                </tr>`;
            }

            document.getElementById('empty-msg').style.display = hasItems ? 'none' : 'block';
            document.getElementById('total-venta').innerText = total.toFixed(2);
            document.getElementById('cart-count').innerText = count + " items";
            calcularCambio();
        }

        window.cambiarPrecio = function(id, nuevoPrecioVal) {
            let nuevoPrecio = parseFloat(nuevoPrecioVal);
            let item = carrito[id];
            if (isNaN(nuevoPrecio) || nuevoPrecio < 0) { renderizarTabla(); return Swal.fire('Precio Inv√°lido', '', 'error'); }

            if (nuevoPrecio < item.costo) {
                Swal.fire({
                    title: '¬°ALERTA DE P√âRDIDA!',
                    text: `El precio ($${nuevoPrecio}) es menor al costo ($${item.costo}). ¬øAutorizar?`,
                    icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, Autorizar'
                }).then((result) => {
                    if (result.isConfirmed) { item.precio = nuevoPrecio; item.subtotal = item.cantidad * nuevoPrecio; renderizarTabla(); }
                    else { renderizarTabla(); }
                });
            } else {
                item.precio = nuevoPrecio;
                item.subtotal = item.cantidad * nuevoPrecio;
                renderizarTabla();
            }
        }

        window.cambiarCantidad = function(id, val) {
            let item = carrito[id];
            let cantidad = parseFloat(val);
            if(cantidad < 1) cantidad = 1;
            if(cantidad > item.stockMax) { cantidad = item.stockMax; Swal.fire({toast:true, title:'Stock M√°ximo', icon:'info'}); }
            item.cantidad = cantidad;
            item.subtotal = item.cantidad * item.precio;
            renderizarTabla();
        }

        window.eliminarItem = function(id) { delete carrito[id]; renderizarTabla(); }

        window.confirmarCancelar = function() {
            if (Object.keys(carrito).length > 0) Swal.fire({title:'¬øCancelar?', showCancelButton:true, confirmButtonText:'S√≠'}).then(r => {if(r.isConfirmed) limpiarCarrito()});
        }
        function limpiarCarrito() { carrito={}; renderizarTabla(); document.getElementById('monto-recibido').value=''; document.getElementById('buscador').value=''; }

        window.verificarCredito = function() {
            let pago = document.getElementById('select-pago').value;
            let input = document.getElementById('monto-recibido');
            if(pago === 'CREDITO') { input.disabled = true; input.value = ''; } else { input.disabled = false; }
            calcularCambio();
        }

        window.calcularCambio = function() {
            let total = parseFloat(document.getElementById('total-venta').innerText);
            let recibido = parseFloat(document.getElementById('monto-recibido').value);
            if(document.getElementById('select-pago').value === 'CREDITO') { document.getElementById('monto-cambio').innerText = '0.00'; return; }
            if(isNaN(recibido)) { document.getElementById('monto-cambio').innerText = '0.00'; return; }
            document.getElementById('monto-cambio').innerText = (recibido - total).toFixed(2);
        }

        window.procesarVenta = function() {
            let clienteId = document.getElementById('select-cliente').value;
            let metodoPago = document.getElementById('select-pago').value;
            let total = parseFloat(document.getElementById('total-venta').innerText);
            let recibido = parseFloat(document.getElementById('monto-recibido').value);

            if (Object.keys(carrito).length === 0) return Swal.fire('Carrito vac√≠o', '', 'warning');
            if (!clienteId) return Swal.fire('Seleccione un Cliente', '', 'warning');
            if (metodoPago !== 'CREDITO' && metodoPago !== 'TRANSFERENCIA' && (isNaN(recibido) || recibido < total)) return Swal.fire('Dinero insuficiente', '', 'error');

            let btn = document.getElementById('btn-confirmar');
            btn.disabled = true; btn.innerHTML = 'Procesando...';

            fetch("{% url 'guardar_venta' %}", {
                method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ cliente_id: clienteId, metodo_pago: metodoPago, productos: carrito })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    Swal.fire({title: '¬°Venta Exitosa!', icon: 'success', showDenyButton: true, confirmButtonText: 'Imprimir Ticket', denyButtonText: 'Nueva Venta'})
                    .then((result) => {
                        if (result.isConfirmed) { window.open(`/imprimir_ticket/${data.id_venta}/`, '_blank'); location.reload(); }
                        else { location.reload(); }
                    });
                } else { Swal.fire('Error', data.mensaje, 'error'); btn.disabled = false; btn.innerHTML = 'CONFIRMAR (F2)'; }
            });
        }
        
        document.addEventListener('keydown', function(event) { if (event.key === 'F2') { event.preventDefault(); procesarVenta(); } });
    </script>
</body>
</html>