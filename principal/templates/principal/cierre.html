{% load static humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cierre de Caja - Comercial 2 Hermanos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #e9ecef; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-cierre { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-bg { background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%); color: white; padding: 2rem; border-radius: 15px 15px 0 0; }
        .money-display { font-size: 2.5rem; font-weight: bold; color: #198754; }
        .list-group-item { border: none; padding: 1rem 1.5rem; }
        .list-group-item:nth-child(even) { background-color: #f8f9fa; }
    </style>
</head>
<body>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                
                <div class="d-flex justify-content-between mb-3">
                    <a href="{% url 'menu' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Volver al Men√∫</a>
                    <span class="text-muted small"><i class="bi bi-clock"></i> {{ fecha_hora|date:"d M Y - H:i" }}</span>
                </div>

                <div class="card card-cierre">
                    <div class="header-bg text-center">
                        <h2 class="mb-0"><i class="bi bi-calculator"></i> Arqueo de Caja</h2>
                        <p class="opacity-75 mb-0">Usuario: {{ usuario.username|upper }}</p>
                    </div>

                    <div class="card-body p-4">
                        
                        {% if cantidad_ventas == 0 and abonos_hoy == 0 and gastos_hoy == 0 %}
                            <div class="alert alert-warning text-center">
                                <i class="bi bi-exclamation-triangle"></i> No se han registrado movimientos desde el √∫ltimo cierre.
                            </div>
                        {% endif %}

                        <h5 class="fw-bold text-secondary mb-3">üíµ Efectivo Esperado en Caj√≥n</h5>
                        <div class="bg-light p-3 rounded-3 border mb-4 text-center">
                            <span class="text-muted small d-block">Debe haber f√≠sicamente:</span>
                            <div class="money-display">${{ efectivo_en_caja|floatformat:2|intcomma }}</div>
                        </div>

                        <h5 class="fw-bold text-secondary mb-3">üìù Detalle de Movimientos</h5>
                        <ul class="list-group shadow-sm mb-4">
                            
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-cart-check-fill text-primary me-2"></i>
                                    <strong>(+) Ventas en Efectivo</strong>
                                </div>
                                <span class="fw-bold text-dark">${{ efectivo_ventas|floatformat:2|intcomma }}</span>
                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-journal-arrow-down text-success me-2"></i>
                                    <strong>(+) Cobros / Abonos</strong>
                                </div>
                                <span class="fw-bold text-success">${{ abonos_hoy|floatformat:2|intcomma }}</span>
                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center bg-danger bg-opacity-10">
                                <div>
                                    <i class="bi bi-dash-circle-fill text-danger me-2"></i>
                                    <strong>(-) Gastos / Salidas</strong>
                                </div>
                                <span class="fw-bold text-danger">-${{ gastos_hoy|floatformat:2|intcomma }}</span>
                            </li>

                            <li class="list-group-item border-top border-2 mt-2"></li>

                            <li class="list-group-item d-flex justify-content-between align-items-center text-muted">
                                <small><i class="bi bi-credit-card"></i> Tarjetas</small>
                                <small>${{ tarjeta|floatformat:2|intcomma }}</small>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center text-muted">
                                <small><i class="bi bi-bank"></i> Transferencias</small>
                                <small>${{ transferencia|floatformat:2|intcomma }}</small>
                            </li>
                        </ul>

                        <div class="d-grid">
                            <button onclick="confirmarCierre()" class="btn btn-danger btn-lg fw-bold shadow">
                                <i class="bi bi-lock-fill"></i> CERRAR CAJA Y GENERAR REPORTE
                            </button>
                        </div>

                    </div>
                    <div class="card-footer text-center text-muted small py-3">
                        √öltimo cierre: {{ ultimo_cierre }}
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        function confirmarCierre() {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "Se cerrar√° el turno actual y se reiniciar√°n los contadores.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'S√≠, Cerrar Caja',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    procesarCierre();
                }
            })
        }

        function procesarCierre() {
            fetch("{% url 'procesar_cierre' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'ok') {
                    Swal.fire(
                        '¬°Caja Cerrada!',
                        'El reporte se ha generado correctamente.',
                        'success'
                    ).then(() => {
                        window.open(`/cierre/imprimir/${data.id_cierre}/`, '_blank');
                        window.location.href = "{% url 'menu' %}";
                    });
                } else {
                    Swal.fire('Error', data.mensaje, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Hubo un problema al procesar el cierre.', 'error');
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>